@using Newtonsoft.Json
@model List<ProjectModel>


@{
    ViewData["Title"] = "Home";
    Layout = "~/Views/Shared/_LayoutPortfolio.cshtml";
}

<div class="content-wrapper">
    
    <!-- Content Header (Page header) -->
    

    <!-- Main content -->

    <section class="content">
        <!--
            <h1>Home</h1>

        <p>Welcome! @ViewBag.studentName</p>
        <p>Yout ID is: @ViewBag.studentIdLogged</p>

        -->

        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Your Projects</h3>

                <ul class="box-controls pull-right">
                    <li><a class="box-btn-slide" href="#"></a></li>
                </ul>
            </div>
            <div class="box-body">
               
                @{Guid studentId = Guid.Empty, projectId = Guid.Empty;}

                @{studentId = Guid.Parse(ViewBag.studentIdLogged);}

                <div style="text-align: center;">
                    <h2><span style="color:dodgerblue">Coming Soon</span>, stay tuned @ViewBag.studentName !</h2>
                    <form asp-action="RegisterStudentProject" asp-controller="Project" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="studentId" value=@studentId />
                        <input type="hidden" name="projectId" id="projectId" value=@projectId />
                        <div class="form-group">
                            <label for="projectName">Name</label>
                            <input name="projectName"  id="projectName" class="form-control"/> 
                            <span validation-for="projectName" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="projectDescription">Description</label>
                            <input name="projectDescription"  id="projectDescription" class="form-control"/> 
                            <span validation-for="projectDescription" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="projectLink">Link to find the project</label>
                            <input name="projectLink"  id="projectLink" class="form-control"/> 
                            <span validation-for="projectLink" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="projectRepoLink">Repository link</label>
                            <input name="projectRepoLink"  id="projectRepoLink" class="form-control"/> 
                            <span validation-for="projectRepoLink" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="projectFramework">Framework o entorno usado</label>
                            <input name="projectFramework"  id="projectFramework" class="form-control"/> 
                            <span validation-for="projectFramework" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="projectLanguages">Lenguajes de programación usados (Separados por comas ",")</label>
                            <input name="projectLanguages"  id="projectLanguages" class="form-control"/> 
                            <span validation-for="projectLanguages" class="text-danger"></span>
                        </div>
                        <input type="file" name="files" id="files" accept="image/*"/>
                        <img src="#" id="uploadedImage" width="200" height="100" hidden/>
                        <input type="file" name="files" id="zip" accept=".zip,.rar,.7zip"/>
                        <input type="submit" value="Upload" id="submitProject"/><br/>
                    </form>
                    <button onclick="cancelEdit()" id="cancelEditButton" hidden>Cancel</button>
                </div>

                <div>
                    @{IDictionary<string,int> languagesDict = new Dictionary<string,int>();
                      IDictionary<string,int> frameworksDict = new Dictionary<string,int>();}
                    @foreach (var project in Model)
                    {
                        if (frameworksDict.ContainsKey(project.projectFramework))
                        {
                            frameworksDict[project.projectFramework] += 1;
                        }
                        else
                        {
                            frameworksDict.Add(project.projectFramework, 1);
                        }
                        string[] projectLanguages = project.projectLanguages.Split(',');
                        for(int i = 0; i < projectLanguages.Length; i++)
                        {
                            if (languagesDict.ContainsKey(projectLanguages[i]))
                            {
                                languagesDict[projectLanguages[i]] += 1;
                            }
                            else
                            {
                                languagesDict.Add(projectLanguages[i], 1);
                            }
                        }
                        <div>
                            <h2>@project.projectName</h2>
                            <p>@project.projectDescription</p>
                            <a href="@project.projectLink">Uploaded link</a><br/>
                            <a href="@project.projectRepoLink">Uploaded link</a>
                            <p>@project.projectFramework</p>
                            <div>
                                @{string jsonObject = JsonConvert.SerializeObject(project);}
                                <button onclick="editProject('@jsonObject')">Edit</button>
                                <button onclick="deleteProject('@project.projectId')">Delete</button>
                            </div>  
                        </div>    
                        <hr />
                    }
                </div>

            </div>
        </div>

        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">Your favourite technologies</h3>
                <ul class="box-controls pull-right">
                    <li><a class="box-btn-slide" href="#"></a></li>
                </ul>
            </div>
            <div class="box-body">
                <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
                <script type="text/javascript">

                  // Load the Visualization API and the corechart package.
                  google.charts.load('current', {'packages':['corechart']});

                  // Set a callback to run when the Google Visualization API is loaded.
                  google.charts.setOnLoadCallback(drawChart);

                  // Callback that creates and populates a data table,
                  // instantiates the pie chart, passes in the data and
                  // draws it.
                  function drawChart() {
                        
                    // Create the data table.
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'Framework');
                    data.addColumn('number', 'Usages');
                    @for(int i = 0; i < frameworksDict.Count(); i++)
                    {
                        @: data.addRows([["@frameworksDict.ElementAt(i).Key.ToUpper()",@frameworksDict.ElementAt(i).Value]]);
                    }

                    var dataLgs = new google.visualization.DataTable();
                    dataLgs.addColumn('string', 'Languages');
                    dataLgs.addColumn('number', 'Usages');
                    @for(int i = 0; i < languagesDict.Count(); i++)
                    {
                        @: dataLgs.addRows([["@languagesDict.ElementAt(i).Key.ToUpper()",@languagesDict.ElementAt(i).Value]]);
                    }

                    // Set chart options
                    var options = {'title':'Favourite Frameworks', "is3D":true, "fontSize":17, "height":500, "fontName": 'Poppins, sans-serif'};
                    var optionsLgs = {'title':'Favourite Programming Languages',"is3D":true,"fontSize":17,"height":500, "fontName": 'Poppins, sans-serif'};

                    // Instantiate and draw our chart, passing in some options.
                    var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
                    chart.draw(data, options);
                    var chartLgs = new google.visualization.PieChart(document.getElementById('chart_div_Lgs'));
                    chartLgs.draw(dataLgs, optionsLgs);
                  }
                </script>
                <div class="row justify-content-between">
                    <div class="col-6">
                        <div id="chart_div" ></div>
                    </div>
                    <div class="col-6">
                        <div id="chart_div_Lgs" ></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
</div>

@section scripts {
    <script>

        document.getElementById('files').onchange = function(evt){
            var target = evt.target;
            var files = target.files;

            if (FileReader && files && files.length) {
                var fr = new FileReader();
                fr.onload = function () {
                    document.getElementById('uploadedImage').removeAttribute('hidden');
                    document.getElementById('uploadedImage').src = fr.result;
                }
                fr.readAsDataURL(files[0]);
            }
        }

        function editProject(project){
            var projectToEdit = JSON.parse(project);
            
            document.getElementById('projectName').setAttribute('value', projectToEdit.projectName); 
            document.getElementById('projectDescription').setAttribute('value', projectToEdit.projectDescription); 
            document.getElementById('projectLink').setAttribute('value', projectToEdit.projectLink); 
            document.getElementById('projectRepoLink').setAttribute('value', projectToEdit.projectRepoLink); 
            document.getElementById('projectFramework').setAttribute('value', projectToEdit.projectFramework); 
            document.getElementById('projectLanguages').setAttribute('value', projectToEdit.projectLanguages); 
            document.getElementById('projectId').setAttribute('value', projectToEdit.projectId); 
            document.getElementById('submitProject').setAttribute('value', 'Edit'); 
            document.getElementById('files').value = "";
            document.getElementById('zip').value = "";
            document.getElementById('cancelEditButton').removeAttribute('hidden'); 
            document.getElementById('uploadedImage').removeAttribute('hidden'); 
            document.getElementById('uploadedImage').setAttribute('src', "data:image/png;base64," + projectToEdit.projectImageData); 
            
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }

        function deleteProject(idProject){
            if (confirm('¿Are you sure you want to delete this project?')) {
                $.ajax({
                    type: 'DELETE',
                    url: '/Project/DeleteStudentProject',
                    data: { projectId: idProject},
                    success: function(){
                        window.location.reload();
                    }
                })
            } 
        }

        function cancelEdit(){
            console.log("cancel");
            document.getElementById('projectName').setAttribute('value', ''); 
            document.getElementById('projectDescription').setAttribute('value', ''); 
            document.getElementById('projectLink').setAttribute('value', ''); 
            document.getElementById('projectRepoLink').setAttribute('value', ''); 
            document.getElementById('projectFramework').setAttribute('value', ''); 
            document.getElementById('projectLanguages').setAttribute('value', ''); 
            document.getElementById('projectId').setAttribute('value', ''); 
            document.getElementById('submitProject').setAttribute('value', 'Upload'); 
            document.getElementById('cancelEditButton').setAttribute('hidden', true); 
            document.getElementById('uploadedImage').setAttribute('hidden', true); 
            document.getElementById('uploadedImage').setAttribute('src', '');
            console.log("cancel2");
        }

        function downloadZip(zipBytes, projectName){
            
            let blob = new Blob([zipBytes], { type: 'application/zip, application/octet-stream'['content-type'] });
            let objectUrl = URL.createObjectURL(blob);
            let link = document.createElement('a');

            link.href = objectUrl;
            link.download = projectName +".zip";
            link.click();

            window.URL.revokeObjectURL(link.href);
        }

        function base64ToArrayBuffer(base64, projectName) {
            var binary_string = window.atob(base64);
            var len = binary_string.length;
            var bytes = new Uint8Array(len);

            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }

            downloadZip(bytes.buffer, projectName);
        }
    </script>
}

